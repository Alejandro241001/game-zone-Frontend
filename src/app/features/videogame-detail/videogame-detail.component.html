<div class="container mt-4" *ngIf="!loading; else loadingTemplate">
  
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="videogame" class="videogame-detail-card">
    
    <div class="row align-items-center">
      <!-- Imagen del videojuego -->
      <div class="col-md-5 text-center">
        <img
          [src]="'http://localhost:8080/img/' + videogame.img"
          [alt]="videogame.name"
          class="img-fluid rounded shadow-sm mb-3 detail-image"
        />
      </div>

      <!-- InformaciÃ³n principal -->
      <div class="col-md-7">
        <h1 class="mb-3">{{ videogame.name }}</h1>
        <hr class="gamezone-divider">

        <!-- ğŸ”§ Modo ediciÃ³n -->
        <div *ngIf="editing; else viewMode">
          <div class="mb-3">
            <label class="form-label"><strong>Nombre:</strong></label>
            <input [(ngModel)]="videogame.name" class="form-control" />
          </div>

          <div class="mb-3">
            <label class="form-label"><strong>DescripciÃ³n:</strong></label>
            <textarea [(ngModel)]="videogame.description" rows="3" class="form-control"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label"><strong>AÃ±o de lanzamiento:</strong></label>
            <input [(ngModel)]="videogame.releaseYear" type="number" class="form-control" />
          </div>

          <div class="mb-3">
            <label class="form-label"><strong>Metacritic:</strong></label>
            <input [(ngModel)]="videogame.metacritic" type="number" class="form-control" />
          </div>

          <button class="btn btn-success me-2" (click)="saveChanges()">ğŸ’¾ Guardar</button>
          <button class="btn btn-secondary" (click)="editing = false">Cancelar</button>
        </div>

        <!-- ğŸ‘â€ğŸ—¨ Modo lectura -->
        <ng-template #viewMode>
          <p><strong>Estudio:</strong> {{ videogame.studio?.name }}</p>
          <p><strong>AÃ±o:</strong> {{ videogame.releaseYear }}</p>
          <p><strong>Metacritic:</strong> {{ videogame.metacritic }}</p>
          
          <p><strong>GÃ©neros:</strong>
            <span *ngFor="let genre of videogame.genres; let last = last">
              {{ genre.name }}<span *ngIf="!last">, </span>
            </span>
          </p>

          <p><strong>Plataformas:</strong>
            <span *ngFor="let platform of videogame.platforms; let last = last">
              {{ platform.name || platform }}<span *ngIf="!last">, </span>
            </span>
          </p>

          <p class="mt-4"><strong>DescripciÃ³n:</strong></p>
          <p>{{ videogame.description || 'Sin descripciÃ³n disponible.' }}</p>
        </ng-template>

        <a routerLink="/videogames" class="btn btn-secondary mt-3 me-2">â† Volver</a>

        <div *ngIf="isManager" class="mt-3">
          <button class="btn btn-primary me-2" (click)="enableEdit()">âœï¸ Editar</button>
          <button class="btn btn-danger" (click)="deleteVideogame()">ğŸ—‘ï¸ Eliminar</button>
        </div>
      </div>
    </div>

    <!-- ========================================================= -->
    <!-- ğŸŒŸ REVIEWS DEL VIDEOJUEGO -->
    <!-- ========================================================= -->

    <hr class="my-4">

    <h2 class="mb-3">ğŸ’¬ ReseÃ±as de usuarios</h2>

    <!-- Si NO hay reviews -->
    <div *ngIf="reviews.length === 0" class="alert alert-info">
      No hay reseÃ±as todavÃ­a. Â¡SÃ© el primero en opinar!
    </div>

    
    
<!-- LISTA DE REVIEWS -->
<div *ngFor="let r of reviews" class="card mb-3 shadow-sm">
  <div class="card-body">

    <!-- CABECERA -->
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title">{{ r.username }}</h5>
      <span class="badge bg-primary fs-6">â­ {{ r.rating }}/10</span>
    </div>

    <!-- ============================= -->
    <!-- MODO EDICIÃ“N DE LA REVIEW -->
    <!-- ============================= -->
    <div *ngIf="editingReviewId === r.id; else viewMode">

      <!-- Texto -->
      <textarea class="form-control mb-2"
                [(ngModel)]="editReview.reviewText" 
                rows="3"></textarea>

      <!-- Rating -->
      <input type="number" class="form-control mb-3"
             [(ngModel)]="editReview.rating"
             min="0" max="10"/>

      <!-- Botones ediciÃ³n -->
      <button class="btn btn-success me-2" (click)="saveEditedReview(r.id)">
        ğŸ’¾ Guardar
      </button>

      <button class="btn btn-secondary" (click)="cancelEdit()">
        Cancelar
      </button>
    </div>

    <!-- ============================= -->
    <!-- MODO NORMAL -->
    <!-- ============================= -->
    <ng-template #viewMode>
      <p class="card-text mt-2">{{ r.reviewText || 'Sin comentario.' }}</p>
      <p class="text-muted small">ğŸ“… {{ r.createdDate | date:'medium' }}</p>

      <!-- BOTONES EDITAR / ELIMINAR -->
      <div *ngIf="isCurrentUserOwner(r.userId) || isManager">
        <button class="btn btn-warning btn-sm me-2" (click)="startEdit(r)">
          âœï¸ Editar
        </button>

        <button class="btn btn-danger btn-sm" (click)="deleteReview(r.id)">
          ğŸ—‘ï¸ Eliminar
        </button>
      </div>
    </ng-template>

  </div>
</div>




    <!-- ========================================================= -->
    <!-- ğŸ“ FORMULARIO PARA CREAR REVIEW (solo si estÃ¡s autenticado) -->
    <!-- ========================================================= -->

    <div *ngIf="authService.isLoggedIn()" class="mt-4">
      <h3>ğŸ“ Escribe tu opiniÃ³n</h3>

      <form (ngSubmit)="submitReview()" #reviewForm="ngForm">

        <label class="form-label fw-bold">PuntuaciÃ³n (0-10):</label>
        <input type="number" class="form-control mb-2" [(ngModel)]="newReview.rating"
               name="rating" min="0" max="10" required />

        <label class="form-label fw-bold">Comentario:</label>
        <textarea class="form-control" rows="3"
                  [(ngModel)]="newReview.reviewText" name="reviewText"></textarea>

        <button class="btn btn-success mt-3" [disabled]="!reviewForm.valid">
          â• Publicar reseÃ±a
        </button>
      </form>
    </div>

  </div>
</div>

<!-- Cargando -->
<ng-template #loadingTemplate>
  <div class="text-center mt-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3">Cargando detalles del videojuego...</p>
  </div>
</ng-template>
